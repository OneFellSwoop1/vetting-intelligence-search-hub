name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-backend:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        # GitHub Actions waits for the service healthcheck to pass before
        # running any steps, so no separate "Wait for Redis" step is needed.

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt

    - name: Create minimal environment.env for Pydantic
      run: |
        cd backend
        cat > environment.env << 'EOF'
        JWT_SECRET_KEY=test_jwt_secret_key_for_ci_testing_min_32_chars_1234567890abcdefghij
        SECRET_KEY=test_secret_key_for_ci_1234567890
        CORS_ORIGINS=http://localhost:3000,http://localhost:8000
        ENVIRONMENT=test
        LOG_LEVEL=INFO
        REDIS_URL=redis://localhost:6379/0
        EOF
        echo "✅ Created environment.env file"

    - name: Check imports and basic functionality
      run: |
        cd backend
        python -c "from app.main import app; print('✅ Backend imports successful')"
      env:
        JWT_SECRET_KEY: 'test_jwt_secret_key_for_ci_testing_min_32_chars_1234567890abcdefghij'
        SECRET_KEY: 'test_secret_key_for_ci_1234567890'
        CORS_ORIGINS: 'http://localhost:3000,http://localhost:8000'
        LDA_API_KEY: 'dummy_key_for_testing_12345678901234567890'
        SOCRATA_API_KEY_ID: 'dummy_socrata_key_id_12345'
        SOCRATA_API_KEY_SECRET: 'dummy_socrata_secret_12345678901234567890123456789012345678'
        SOCRATA_APP_TOKEN: 'dummy_app_token_12345678'
        FEC_API_KEY: 'dummy_fec_key_for_testing_1234567890'
        ENVIRONMENT: 'test'
        LOG_LEVEL: 'INFO'
        REDIS_URL: 'redis://localhost:6379/0'

  test-frontend:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Create .env.local for Next.js
      run: |
        cd frontend
        cat > .env.local << 'EOF'
        NODE_ENV=development
        NEXT_PUBLIC_SITE_URL=https://poissonai.com
        NEXT_PUBLIC_API_URL=http://localhost:8000
        EOF
        echo "✅ Created .env.local file"

    - name: Type check
      run: |
        cd frontend
        npx tsc --noEmit
      env:
        NODE_ENV: 'development'

    - name: Build
      run: |
        cd frontend
        npm run build
      env:
        NODE_ENV: 'development'
        NEXT_PUBLIC_SITE_URL: 'https://poissonai.com'
        NEXT_PUBLIC_API_URL: 'http://localhost:8000'
